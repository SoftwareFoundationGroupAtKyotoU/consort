incr(x, max, l) {
    acq(l);
    assert(*x <= max);
    if *x < max then {
        x := *x + 1;
        assert(*x <= max);
        rel(l);
    } else {
        rel(l);
        incr(x, max, l);
    }
}

{
    let min = 0 in
    let max = 2 in
    let x = mkref min in
    let l = newlock() in
    let t = fork({
        incr(x, max, l);
    }) in {
        incr(x, max, l);
        wait(t);
        freelock(l);
    }
}
